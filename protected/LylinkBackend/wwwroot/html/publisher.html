<!DOCTYPE html>
<html lang="en">
<head>
    <title>Lylink - Publisher</title>

    <link id="siteStyle" rel="stylesheet" href="css/site_style.css" onerror="showAdblockPopup()" />
    <link id="mobileStyle" rel="stylesheet" href="css/mobile_style.css" onerror="showAdblockPopup()" />
    <link id="sliderStyle" rel="stylesheet" href="css/slider_style.css" onerror="showAdblockPopup()" />
    <link id="adblockStyle" rel="stylesheet" href="css/adblock_style.css" onerror="showAdblockPopup()" />
    <link id="tableStyle" rel="stylesheet" href="css/table_style.css" onerror="showAdblockPopup()" />

    <link id="lightStyle" rel="stylesheet" href="css/light_mode.css" disabled onerror="showAdblockPopup()" />
    <link id="darkStyle" rel="stylesheet" href="css/dark_mode.css" disabled onerror="showAdblockPopup()" />

    <link id="tabsStyle" rel="stylesheet" href="css/tabs_style.css" onerror="showAdblockPopup()" />

    <link id="icon" rel="icon" type="image/x-icon" href="css/lylink_icon.ico" onerror="showAdblockPopup()" />

    <script src="js/color_slider.js" defer></script>
    <script src="js/tabs.js" defer></script>

    <meta charset="UTF-8" />
    <meta name="keywords" content="lylink, post, manager" />
    <meta name="description" content="Lylink - Publisher" />
    <meta name="author" content="Lylink">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div id="adblock-background">
    </div>
    <div id="adblock-popup">
        <p>Hey, it looks like a resource failed to load. If you have an ad-blocker, please turn it off.</p>
        <p>This site will never have ads. Please turn off your ad-blocker so my stylesheets load properly.</p>
        <p>Thank you.</p>
        <button onclick="closePopup()">Close</button>
    </div>
    <div id="page-container">
        <div id="content-wrap">
            <label id="colorStyleSwitch" class="switch">
                <input id="colorStyleSwitchCheckbox" type="checkbox">
                <span class="slider" onclick="handleColorStyleSwitching()"></span>
            </label>
            <header>
                <div style="width: 40%; display: inline-block">
                    <h3><a href="/">index</a> → <a href="/management?accessToken=ACCESSTOKENREPLACEHERE">management</a> →</h3>
                    <h1 id="website-header">
                        Publisher
                    </h1>
                    <h5>Updated 23:36 on 8/25/2023</h5>
                </div>
                <form style="width: 39%; display: inline-block">
                    <button onclick="saveDraft()" type="button">Save Draft</button><br />
                    <label>View HTML <input id="showHTML" type="checkbox" checked onchange="swapView(this)" /></label><br />
                    <label>Disable Text Editor <input id="disableEditor" type="checkbox" checked onchange="toggleEditor(this)" disabled /></label><br />
                    <label>Posts <select onchange="getSlugBody(this)" id="slugBox"></select></label><br />
                    <label>Category <select id="categoryBox"></select></label><br />
                </form>
            </header>
            <div class="container">
                <input type="text" width="22%" id="title" placeholder="title" /><input type="text" width="22%" id="description" placeholder="description" />
                <input type="text" width="22%" id="keywords" placeholder="keywords" /><input type="text" width="22%" id="slug" placeholder="slug" />
                <input type="text" width="22%" id="name" placeholder="name" />
                <main>
                    <div width="100%"><pre width="100%" id="body" contenteditable="true"></pre></div>
                    <div id="preview"></div>
                </main>
            </div>
        </div>
        <footer>
            <p>
                Copyright 2024, All Rights Reserved
            </p>
        </footer>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/simply-beautiful@latest/dist/index.min.js"></script>

    <script defer>
        const urlParams = new URLSearchParams(window.location.search);
        let allSlugs;

        var options = {
            indent_size: 4,
            max_char: 0
        };

        var beautify = SimplyBeautiful();

        document.getElementById('body').addEventListener('keydown', function (event) {
            if (event.key === 'Tab') {
                event.preventDefault(); // Prevent the default tab behavior

                // Get the current selection
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);

                // Create a text node containing 4 spaces
                const spaceNode = document.createTextNode('    ');

                // Insert the 4 spaces at the cursor position
                range.insertNode(spaceNode);

                // Move the cursor to after the inserted spaces
                range.setStartAfter(spaceNode);
                range.setEndAfter(spaceNode);

                // Clear the selection and update the cursor position
                selection.removeAllRanges();
                selection.addRange(range);
            }

            if (event.ctrlKey && event.key === 'i') {
                event.preventDefault(); // Prevent the default behavior of Ctrl+I

                // Get the current selection
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                const selectedText = selection.toString();

                if (selectedText.length > 0) {
                    const textWithEm = `<em>${selectedText}</em>`;

                    // Check if the selection already contains <em> and </em>
                    if (selectedText.startsWith('<em>') && selectedText.endsWith('</em>')) {
                        // Remove the <em> and </em> tags from the selected text
                        const newText = selectedText.slice(4, -5); // Remove the <em> and </em> part
                        range.deleteContents(); // Clear the selected text
                        range.insertNode(document.createTextNode(newText)); // Insert plain text
                    } else {
                        // Add <em> and </em> around the selected text
                        range.deleteContents(); // Clear the selected text
                        range.insertNode(document.createTextNode(textWithEm)); // Insert <em>wrapped</em> text
                    }
                }
            }
        });

        const accessToken = urlParams.get("accessToken");

        getAllCategoryNames();
        getAllSlugs();

        function getAllSlugs() {
            // Make a POST request to the /test endpoint
            fetch(`/getAllSlugs?accessToken=${accessToken}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json' // Assuming you're sending JSON
                },
            })
            .then(async response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }

                response = await response.text();

                return JSON.parse(response);
            })
            .then(data => {
                const slugBox = document.getElementById('slugBox');

                let blankOpt = document.createElement("option");
                blankOpt.value = null;
                blankOpt.innerHTML = '';
                slugBox.append(blankOpt);

                allSlugs = data;

                console.log(allSlugs);

                data.map((slug, i) => {
                    let opt = document.createElement("option");
                    opt.value = slug;
                    opt.innerHTML = slug;
                    slugBox.append(opt);
                });
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
        }

        async function getAllCategoryNames() {
            // Make a POST request to the /test endpoint
            await fetch(`/getAllCategoryNames?accessToken=${accessToken}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json' // Assuming you're sending JSON
                },
            })
            .then(async response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }

                response = await response.text();

                return JSON.parse(response);
            })
            .then(data => {
                const categoryBox = document.getElementById('categoryBox');

                let blankOpt = document.createElement("option");
                blankOpt.value = 'none';
                blankOpt.innerHTML = 'none';
                categoryBox.append(blankOpt);

                data.map((category, i) => {
                    let opt = document.createElement("option");
                    opt.value = category;
                    if (category === "") {
                        opt.innerHTML = "index";
                    }
                    else {
                        opt.innerHTML = category;
                    }
                    categoryBox.append(opt);
                });
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
        }

        function getSlugBody(slugBox) {
            fetch(`/getSlugPost?accessToken=${accessToken}&slug=${slugBox.value}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json' // Assuming you're sending JSON
                },
            })
                .then(async response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }

                    response = await response.text();

                    return JSON.parse(response);
                })
                .then(data => {
                    document.getElementById('title').value = data.title;
                    document.getElementById('keywords').value = data.keywords;
                    document.getElementById('description').value = data.description;
                    document.getElementById('name').value = data.name;
                    document.getElementById('slug').value = data.slug;

                    if (document.getElementById('showHTML').checked) {
                        var a = beautify.html(data.body, options);

                        console.log(a);

                        document.getElementById('body').textContent = a;
                    }
                    else {
                        document.getElementById('preview').innerHTML = data.body;
                    }

                    console.log(data);

                    if (data.parentSlug === undefined) {
                        document.getElementById('categoryBox').value = 'none';
                    }
                    else {
                        document.getElementById('categoryBox').value = data.parentSlug;
                    }
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
        }

        function saveDraft() {
            const data =
            {
                title: document.getElementById('title').value,
                keywords: document.getElementById('keywords').value,
                description: document.getElementById('description').value,
                dateModifiedISO: new Date().toISOString(),
                name: document.getElementById('name').value,
                slug: document.getElementById('slug').value,
                body: document.getElementById('body').textContent,
                parentSlug: document.getElementById('categoryBox').value
            };

            if (allSlugs.indexOf(data.slug) == -1) {
                data.dateCreatedISO = new Date(data.dateModifiedISO).toISOString();
            }

            // Make a POST request to the /test endpoint
            fetch(`/sendPost?accessToken=${accessToken}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json' // Assuming you're sending JSON
                },
                body: JSON.stringify(data) // Replace with your actual data
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }

                    return response;
                })
                .then(data => {
                    console.log('Data received:', data);
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
        }

        function swapView(element) {
            if (element.checked) {
                document.getElementById('body').textContent = beautify.html(document.getElementById('preview').innerHTML, options);
                document.getElementById('body').style.display = 'block';
                document.getElementById('preview').style.display = 'none';
                document.getElementById('disableEditor').disabled = true;
            } else {
                let parsedText = parseMarkdown(document.getElementById('body').textContent);
                document.getElementById('preview').innerHTML = parsedText;
                document.getElementById('preview').style.display = 'block';
                document.getElementById('body').style.display = 'none';
                document.getElementById('disableEditor').disabled = false;
            }
        }

        function toggleEditor(element) {
            if (element.checked) {
                document.getElementById('preview').contentEditable = true;
            }
            else {
                document.getElementById('preview').contentEditable = false;
            }
        }

        function parseMarkdown(text) {
            // Replace *Bold* with <strong>Bold</strong>
            text = text.replace(/\*(.*?)\*/g, '<strong>$1</strong>');

            // Replace _Italicized_ with <em>Italicized</em>
            text = text.replace(/_(.*?)_/g, '<em>$1</em>');

            return text;
        }
    </script>
</body>
</html>